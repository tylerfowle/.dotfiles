#!/usr/bin/env bash

# save the active Chrome window source
# to files [cc.tmp.html] and [dev.tmp.html]

# usage
# savesite filename

if command -v figlet >/dev/null 2>&1; then
figlet -f morse "savesite"
fi

IFS='%'
appName="Google Chrome"

URL=$(/usr/bin/osascript << EOT
tell application "System Events"
  try
    tell application "Google Chrome"
      return URL of active tab of front window
    end tell
  end try
end tell
EOT)

FILE_LIVE_EXTENSION="-cc.tmp.html"
FILE_DEV_EXTENSION="-dev.tmp.html"

FILENAME_LIVE=${1:-"site"}
FILENAME_DEV=${1:-"site"}

FILENAME_LIVE="${FILENAME_LIVE}${FILE_LIVE_EXTENSION}"
FILENAME_DEV="${FILENAME_DEV}${FILE_DEV_EXTENSION}"

echo "==> $FILENAME_LIVE"
echo "==> $FILENAME_DEV"
echo "==>"

if [ -f $FILENAME_LIVE ]; then
  echo "==> file $FILENAME_LIVE already exists... deleting file"
  rm $FILENAME_LIVE
fi

if [ -f $FILENAME_DEV ]; then
  echo "==> file $FILENAME_DEV already exists... deleting file"
  rm $FILENAME_DEV
fi

echo "==>"
echo "==> saving ${URL} as:"
echo "==> ${FILENAME_LIVE}"
echo "==> ${FILENAME_DEV}"
echo "==>"

curl $URL > $FILENAME_LIVE
cp $FILENAME_LIVE $FILENAME_DEV

# LIVE / CC
##################################################################
# add stylesheet for theme right before </head>
sed -i '' '/<\/head>/i\
<link rel="stylesheet" href="css/stylesheet.css">\
' $FILENAME_LIVE
##################################################################

# DEV / LOCAL
##################################################################
# add stylesheet for theme right before </head>
sed -i '' '/<\/head>/i\
<link rel="stylesheet" href="css/stylesheet.css">\
' $FILENAME_DEV

# remove hardlinked css
sed -i '' '/stylesheet.*designs.*.css/d' $FILENAME_DEV

# remove hardlinked js
sed -i '' '/script.*designs.*.js/d' $FILENAME_DEV

# add theme js right before </body>
sed -i '' '/<\/body>/i\
<script src="js/site.min.js" type="text/javascript"></script>\
' $FILENAME_DEV
##################################################################
